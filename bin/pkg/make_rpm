#!/bin/bash

PATH_SCRIPT="$(cd $(/usr/bin/dirname $(type -p -- $0 || echo $0));pwd)"
. $PATH_SCRIPT/make.lib

prepare_chroot || exit 1

SPEC_D=$OSVC/tmp/SPECS
SPEC=$SPEC_D/opensvc.spec

[ ! -d $SPEC_D ] && {
	mkdir -p $SPEC_D || exit 1
}

cat - <<-EOF >$SPEC
Summary: $SUMMARY
Name: opensvc
Version: $VERSION
Release: $RELEASE
License: GPLv2
Group: Administration/Tools
BuildRoot: $CHROOT
Provides: opensvc
AutoReqProv: no
%define _source_filedigest_algorithm 1
%define _binary_filedigest_algorithm 1
%define _source_payload w9.gzdio
%define _binary_payload w9.gzdio

%description
$DESCRIPTION

%post
/usr/lib/opensvc/bin/postinstall
%files
%docdir /usr/share/doc/opensvc
%defattr(-,root,root)
%attr(0755,root,root) /usr/lib/opensvc/bin/opensvc
%attr(0755,root,root) /usr/lib/opensvc/bin/postinstall
%attr(0755,root,root) /usr/lib/opensvc/bin/init
/usr/lib/opensvc/lib
/usr/share/doc/opensvc
/etc/opensvc
/var/log/opensvc
/var/tmp/opensvc
/var/lib/opensvc
/etc/bash_completion.d/opensvc
/usr/lib/opensvc/bin/nodemgr
/usr/lib/opensvc/bin/svcmgr
/usr/lib/opensvc/bin/svcmon
/usr/bin/nodemgr
/usr/bin/svcmgr
/usr/bin/svcmon

#%changelog
#\$(changelog)
EOF

sudo rpmbuild --target=noarch --define "_topdir $OSVC/tmp" --clean -bb $SPEC

[ -x $PATH_SCRIPT/release_rpm ] && $PATH_SCRIPT/release_rpm $OSVC/tmp/RPMS/noarch/opensvc-$VERSION-$RELEASE.noarch.rpm

#!/bin/bash

PATH_SCRIPT="$(cd $(/usr/bin/dirname $(type -p -- $0 || echo $0));pwd)"

function date_to_release {
	date -d "$*" +%y%m%d.%H%M
}

function changelog {
	git log --pretty=format:"* %ad - %ae%n- %s" | sed -e "s/ [0-9]*:[0-9]*:[0-9]*//" -e "s/ +[0-9]* -/ -/"
}

HEAD=$(git log -1 --pretty=format:%aD || exit 1)
VERSION=1.0
RELEASE=$(date_to_release $HEAD)
OSVC=$PATH_SCRIPT/../..
CHROOT=$OSVC/tmp/BUILDROOT/opensvc-$VERSION-$RELEASE.noarch
SPEC=$OSVC/tmp/SPECS/opensvc.spec
DEBDIR=$OSVC/tmp/DEB
DEB=opensvc-$VERSION-$RELEASE.noarch.deb

#
# prepare skeleton (data.tar.gz)
#
[ "${CHROOT%%noarch}" != "$CHROOT" ] && rm -rf $CHROOT
mkdir -p $CHROOT/usr/local/opensvc/etc || exit 1
mkdir -p $CHROOT/usr/local/opensvc/var || exit 1
mkdir -p $CHROOT/usr/local/opensvc/log || exit 1
mkdir -p $CHROOT/usr/local/opensvc/tmp || exit 1
mkdir -p $CHROOT/usr/local/opensvc/var || exit 1

# install tracked files
EXCL=
EXCL="$EXCL --exclude=bin/pkg"
EXCL="$EXCL --exclude=*.pyc"
EXCL="$EXCL --exclude='log/*'"
EXCL="$EXCL --exclude='etc/*'"
EXCL="$EXCL --exclude='tmp/*'"
EXCL="$EXCL --exclude=var/host_mode"
EXCL="$EXCL --exclude='var/lock/*'"
cd $OSVC || exit 1
tar cf - $EXCL bin lib usr | tar xf - -C $CHROOT/usr/local/opensvc || exit 1
touch $CHROOT/usr/local/opensvc/var/host_mode || exit 1

# symbolic links
cd $CHROOT || exit 1
ln -s usr/local/opensvc service || exit 1


# prepare control.tar.gz
mkdir -p $CHROOT/DEBIAN || exit 1

cat - <<-EOF >$CHROOT/DEBIAN/postinst
#/bin/sh
/service/bin/postinstall
EOF
chmod 755 $CHROOT/DEBIAN/postinst

cat - <<-EOF >$CHROOT/DEBIAN/control
Package: opensvc
Version: $RELEASE-$VERSION
Section: system 
Priority: optional
Architecture: all
Essential: no
Depends: python2.6
Pre-Depends: 
Recommends: sg3-utils
Suggests: 
Installed-Size: 50
Maintainer: Christophe Varoqui [christophe.varoqui@opensvc.com]
Conflicts: 
Replaces: 
Provides: opensvc
Description: tools to drive OpenSVC services
EOF

dpkg -b $CHROOT || exit 1

[ -x $PATH_SCRIPT/release_deb ] && $PATH_SCRIPT/release_deb $CHROOT/../$DEB

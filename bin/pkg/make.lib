function changelog {
        git log --pretty=format:"* %ad - %ae%n- %s" | sed -e "s/ [0-9]*:[0-9]*:[0-9]*//" -e "s/ +[0-9]* -/ -/"
}

function date_to_release {
	/opt/opensvc/bin/python -c "import datetime ; print(datetime.datetime.fromtimestamp($1).strftime('%y%m%d.%H%M'))"
}

OFFSET=10000
HEAD=$(git log -1 --pretty=format:%at || exit 1)
VERSION=$(git describe --tags --abbrev=0)
RELEASE=$(git describe --tags|cut -d- -f2)
[ "$RELEASE" == "$VERSION" ] && RELEASE=0

MASTER=0
git branch | grep "\* master" >/dev/null 2>&1 && MASTER=1
if [ $MASTER -eq 1 ] ; then
	let RELEASE=$RELEASE+$OFFSET
else
	RELEASE=$(git describe --tags|cut -d- -f2)
        if [ "$RELEASE" = "$VERSION" ] ; then
            RELEASE="0"
        fi   
fi
OSVC=$PATH_SCRIPT/../..
CHROOT_BN=opensvc-$VERSION-$RELEASE.noarch
CHROOT=$OSVC/tmp/BUILDROOT/$CHROOT_BN

if [ "$(uname)" == "SunOS" -a -x /usr/xpg4/bin/id ] ; then
	ID_BIN="/usr/xpg4/bin/id"
else
	ID_BIN="id"
fi

if [ "$($ID_BIN -u)" == "0" ] ; then
	SUDO=""
else
	SUDO="sudo"
fi

function prepare_chroot {
	#
	# prepare skeleton (data.tar.gz)
	#
	echo $CHROOT | grep noarch >/dev/null 2>&1 && $SUDO rm -rf $CHROOT

	mkdir -p $CHROOT/opt/opensvc

	# install tracked files
	cd $OSVC || return 1
	git archive --format=tar HEAD | ( cd $CHROOT/opt/opensvc && tar xf - )

	# install version.py
	echo "version = \"$VERSION-$RELEASE\"" | tee $CHROOT/opt/opensvc/lib/version.py || return 1

	# compress docs
	cd $CHROOT/opt/opensvc/usr/share/doc
	for f in $(echo template*env)
	do
		echo "gzip $f"
		gzip $f
	done

	# purge unwanted files
	rm -rf $CHROOT/opt/opensvc/bin/pkg
	rm -f $CHROOT/opt/opensvc/bin/postinstall.cmd

	# move files to LSB locations
	mkdir -p $CHROOT/usr/bin
	mkdir -p $CHROOT/etc/opensvc
	mkdir -p $CHROOT/var/log/opensvc
	mkdir -p $CHROOT/var/tmp/opensvc
	mkdir -p $CHROOT/var/lib/opensvc/cache
	mkdir -p $CHROOT/usr/lib/opensvc
	mkdir -p $CHROOT/usr/share/doc/opensvc
	mkdir -p $CHROOT/etc/bash_completion.d
	mv $CHROOT/opt/opensvc/bin $CHROOT/usr/lib/opensvc/
	mv $CHROOT/opt/opensvc/lib $CHROOT/usr/lib/opensvc/
	mv $CHROOT/opt/opensvc/var/compliance $CHROOT/var/lib/opensvc/
	mv $CHROOT/opt/opensvc/usr/share/doc/* $CHROOT/usr/share/doc/opensvc/
	mv $CHROOT/opt/opensvc/usr/share/bash_completion.d/opensvc $CHROOT/etc/bash_completion.d/
	ln -sf /usr/lib/opensvc/bin/opensvc $CHROOT/usr/bin/svcmgr
	ln -sf /usr/lib/opensvc/bin/opensvc $CHROOT/usr/bin/nodemgr
	ln -sf /usr/lib/opensvc/bin/opensvc $CHROOT/usr/bin/svcmon

	# purge unwanted files
	rm -rf $CHROOT/opt/opensvc

	cd $OSVC
	$SUDO chown -R 0:0 $CHROOT/* || return 1

	return 0
}

